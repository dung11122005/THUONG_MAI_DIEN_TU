<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <meta http-equiv="x-ua-compatible" content="ie=edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>Verify OTP</title>
    <link rel="icon" type="image/png" href="client/img/iconLaptopShop.png" />
    <link
      rel="stylesheet"
      href="https://use.fontawesome.com/releases/v5.15.2/css/all.css"
    />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700;900&display=swap"
    />
    <link rel="stylesheet" href="/client/css/bootstrap-login-form.min.css" />
  </head>

  <body>
    <style>
      .divider:after,
      .divider:before {
        content: "";
        flex: 1;
        height: 1px;
        background: #eee;
      }
      .h-custom {
        height: calc(100% - 73px);
      }
      @media (max-width: 450px) {
        .h-custom {
          height: 100%;
        }
      }
      .resend-link {
        text-decoration: none;
        color: #4285f4;
        font-weight: 500;
        cursor: pointer;
      }
      .resend-link:hover {
        text-decoration: underline;
      }
      .dev-otp {
        background: #f8f9fa;
        padding: 10px;
        border-radius: 5px;
        margin-top: 10px;
        font-family: monospace;
        border-left: 3px solid #20c997;
      }
    </style>

    <section class="vh-100">
      <div class="container-fluid h-custom">
        <div class="row d-flex justify-content-center align-items-center h-100">
          <div class="col-md-9 col-lg-6 col-xl-5">
            <img
              loading="lazy"
              src="https://mdbcdn.b-cdn.net/img/Photos/new-templates/bootstrap-login-form/draw2.webp"
              class="img-fluid"
              alt="Sample image"
            />
          </div>

          <div class="col-md-8 col-lg-6 col-xl-4 offset-xl-1">
            <form th:action="@{/verify-otp}" method="post">
              <div class="divider d-flex align-items-center my-4">
                <p class="text-center fw-bold mx-3 mb-0">Xác thực 2 lớp</p>
              </div>

              <div
                th:if="${otpResent}"
                class="alert alert-success"
                role="alert"
              >
                Mã OTP mới đã được gửi. Vui lòng kiểm tra.
              </div>

              <div
                th:if="${session.otpSendError != null}"
                class="my-2 alert alert-warning"
                th:text="${session.otpSendError}"
              ></div>

              <div
                th:if="${error}"
                class="my-2 alert alert-danger"
                th:text="${error}"
              ></div>

              <p class="small text-muted mb-3">
                Nhập mã OTP đã gửi tới số điện thoại/ email của bạn.
              </p>

              <div id="timer" class="mb-2">
                <small
                  >Thời gian còn lại: <span id="countdown">03:00</span></small
                >
              </div>

              <div class="form-outline mb-4">
                <input
                  id="otpInput"
                  type="text"
                  class="form-control form-control-lg"
                  name="otp"
                  placeholder="Nhập mã OTP"
                  required
                  autofocus
                />
                <label class="form-label">Mã OTP</label>
              </div>

              <!-- Thêm nút gửi lại OTP -->
              <div class="text-center mb-3">
                <a th:href="@{/resend-otp}" class="resend-link">
                  <i class="fas fa-sync-alt me-1"></i> Gửi lại mã OTP
                </a>
              </div>

              <input
                type="hidden"
                th:name="${_csrf.parameterName}"
                th:value="${_csrf.token}"
              />

              <div class="text-center text-lg-start mt-3 pt-2">
                <button id="submitBtn" class="btn btn-primary btn-lg w-100">
                  Xác minh
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <div
        class="d-flex flex-column flex-md-row text-center text-md-start justify-content-between py-4 px-4 px-xl-5 bg-primary"
      >
        <div class="text-white mb-3 mb-md-0">
          Bản quyền HOÀNG TẤN DŨNG © 2024. mọi quyền được bảo lưu.
        </div>
        <div>
          <a href="#!" class="text-white me-4"
            ><i class="fab fa-facebook-f"></i
          ></a>
          <a href="#!" class="text-white me-4"
            ><i class="fab fa-twitter"></i
          ></a>
          <a href="#!" class="text-white me-4"><i class="fab fa-google"></i></a>
          <a href="#!" class="text-white"><i class="fab fa-linkedin-in"></i></a>
        </div>
      </div>
    </section>

    <script>
      (function () {
        const DURATION = 3 * 60; // seconds
        const countdownEl = document.getElementById("countdown");
        const submitBtn = document.getElementById("submitBtn");
        const otpInput = document.getElementById("otpInput");
        const form = document.querySelector("form");

        if (!countdownEl || !submitBtn || !otpInput || !form) {
          return;
        }

        // use a sessionStorage key; reset on successful submit
        const KEY = "otpExpireTime";
        let endTime = sessionStorage.getItem(KEY);
        if (!endTime) {
          endTime = Date.now() + DURATION * 1000;
          sessionStorage.setItem(KEY, String(endTime));
        } else {
          endTime = parseInt(endTime, 10);
          if (isNaN(endTime)) {
            endTime = Date.now() + DURATION * 1000;
            sessionStorage.setItem(KEY, String(endTime));
          }
        }

        function showExpiredMessage() {
          if (!document.getElementById("errorExpired")) {
            const div = document.createElement("div");
            div.id = "errorExpired";
            div.className = "alert alert-danger my-2";
            div.textContent = "Mã OTP đã hết hạn. Vui lòng yêu cầu gửi lại.";
            form.insertBefore(div, form.firstChild);
          }
        }

        function update() {
          const now = Date.now();
          const diff = Math.floor((endTime - now) / 1000);
          if (diff <= 0) {
            countdownEl.textContent = "00:00";
            submitBtn.disabled = true;
            otpInput.disabled = true;
            showExpiredMessage();
            return;
          }
          const mm = String(Math.floor(diff / 60)).padStart(2, "0");
          const ss = String(diff % 60).padStart(2, "0");
          countdownEl.textContent = mm + ":" + ss;
          setTimeout(update, 1000);
        }

        update();

        // Reset timer when resending OTP
        const resendLink = document.querySelector(".resend-link");
        if (resendLink) {
          resendLink.addEventListener("click", function () {
            sessionStorage.removeItem(KEY);
          });
        }

        form.addEventListener("submit", function (e) {
          const now = Date.now();
          if (now > endTime) {
            submitBtn.disabled = true;
            otpInput.disabled = true;
            showExpiredMessage();
            e.preventDefault();
            return;
          }
          // valid submit -> remove expiry so next flow restarts timer
          sessionStorage.removeItem(KEY);
        });
      })();
    </script>

    <script type="text/javascript" src="/client/js/mdb.min.js"></script>
  </body>
</html>
